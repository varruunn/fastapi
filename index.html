<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Notes | FastAPI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* Small UI polish beyond Tailwind defaults */
        :root {
            color-scheme: dark;
        }

        html,
        body {
            height: 100%;
        }

        ::selection {
            background: rgba(99, 102, 241, 0.35);
        }

        /* Scrollbars (Chromium / Edge) */
        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        *::-webkit-scrollbar-track {
            background: rgba(24, 24, 27, 0.4);
            border-radius: 999px;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.35);
            border-radius: 999px;
            border: 2px solid rgba(24, 24, 27, 0.55);
        }

        *::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-in {
            animation: cardIn 240ms ease-out both;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-zinc-950 via-zinc-900 to-indigo-950 text-zinc-50">
    <div class="min-h-screen flex items-center justify-center px-4 py-10">
        <div
            class="card-in w-full max-w-5xl rounded-3xl border border-zinc-800/70 bg-zinc-900/55 text-zinc-50 shadow-2xl shadow-black/40 backdrop-blur">
            <header class="border-b border-zinc-800/70 px-6 py-5 flex flex-wrap items-center justify-between gap-3">
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-semibold tracking-tight text-zinc-50">Secure Notes</h1>
                        <span
                            class="inline-flex items-center gap-2 rounded-full border border-indigo-500/30 bg-indigo-500/10 px-2.5 py-1 text-[11px] font-medium text-indigo-200">
                            <span class="h-1.5 w-1.5 rounded-full bg-indigo-300"></span>
                            JWT secured
                        </span>
                    </div>
                    <p class="text-sm text-zinc-300 mt-1">FastAPI-powered, token-secured personal notes</p>
                </div>
                <div class="flex items-center gap-2 text-[11px] text-zinc-400">
                    <span class="hidden sm:inline">Tip:</span>
                    <span class="rounded-full border border-zinc-800/80 bg-zinc-950/40 px-2.5 py-1">Use search to filter
                        instantly</span>
                </div>
            </header>

            <main class="flex-1 px-6 py-6">
                <div class="grid gap-6 w-full lg:grid-cols-[minmax(0,1.05fr)_minmax(0,1.95fr)]">

                    <!-- Auth section -->
                    <section class="space-y-4" id="auth-section">
                        <div class="flex items-center justify-between">
                            <h2 class="text-sm font-medium uppercase tracking-[0.16em] text-zinc-300">Account</h2>
                            <span class="text-xs text-zinc-400">JWT-based authentication</span>
                        </div>

                        <div class="rounded-2xl border border-zinc-800/80 bg-zinc-950/40 px-4 py-4 shadow-sm space-y-3">
                            <div id="auth-message" class="min-h-4 text-xs text-zinc-300"></div>
                            <div class="flex flex-col gap-2" id="auth-fields">
                                <input id="auth-username" type="email" placeholder="Email Address"
                                    class="w-full rounded-lg border border-zinc-600 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                                <input id="auth-password" type="password" placeholder="Password (min 12 characters, mixed case, number & symbol)"
                                    class="w-full rounded-lg border border-zinc-600 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                            </div>
                            <div class="flex items-center justify-between mt-3 gap-3">
                                <div class="space-x-2" id="auth-buttons">
                                    <button id="btn-register"
                                        class="inline-flex items-center justify-center rounded-lg border border-zinc-700/80 bg-zinc-950/30 px-4 py-2 text-xs font-medium text-zinc-100 shadow-sm transition hover:border-zinc-600 hover:bg-zinc-900/50 cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500/40"
                                        type="button">
                                        Register
                                    </button>
                                    <button id="btn-login"
                                        class="inline-flex items-center justify-center rounded-lg bg-indigo-500 px-4 py-2 text-xs font-medium text-white shadow-sm transition hover:bg-indigo-400 cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500/40"
                                        type="button">
                                        Login
                                    </button>
                                </div>
                                <div id="auth-status" class="flex-1 text-right text-xs text-zinc-400"></div>
                                <button id="btn-logout"
                                    class="hidden text-xs font-medium text-rose-300 hover:text-rose-200 cursor-pointer"
                                    type="button">
                                    Logout
                                </button>
                            </div>
                            <!-- Email verification status & controls (visible when logged in) -->
                            <div id="email-verification" class="mt-3 hidden border-t border-zinc-800/70 pt-3 space-y-2 text-xs">
                                <div id="email-verification-status" class="text-amber-300">
                                    Email not verified. Request a code and check your inbox.
                                </div>
                                <div id="email-verification-controls" class="flex flex-wrap items-center gap-2">
                                    <button id="btn-send-verification"
                                        class="inline-flex items-center justify-center rounded-lg border border-indigo-500/50 bg-indigo-500/20 px-3 py-1 text-[11px] font-medium text-indigo-100 hover:bg-indigo-500/30 cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                                        Send verification code
                                    </button>
                                    <input id="email-verification-code" type="text" placeholder="Enter 6-digit code"
                                        class="w-32 rounded-lg border border-zinc-600 bg-zinc-900/60 px-2 py-1 text-[11px] text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                                    <button id="btn-verify-email"
                                        class="inline-flex items-center justify-center rounded-lg bg-emerald-500 px-3 py-1 text-[11px] font-medium text-white hover:bg-emerald-400 cursor-pointer focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                                        Verify
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Notes app section (hidden until logged in) -->
                    <section id="app-section" class="hidden space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-sm font-medium uppercase tracking-[0.16em] text-zinc-300">Notes</h2>
                            <span class="text-xs text-zinc-400">Private to your account</span>
                        </div>

                        <form id="note-form"
                            class="space-y-4 rounded-2xl border border-zinc-800/80 bg-zinc-950/40 px-4 py-4 shadow-sm">
                            <div class="grid gap-3 md:grid-cols-[minmax(0,0.45fr)_minmax(0,1.55fr)]">
                                <div>
                                    <label
                                        class="block text-xs font-medium tracking-wide text-zinc-300 mb-1">Title</label>
                                    <input id="title" type="text"
                                        class="w-full rounded-lg border border-zinc-600 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40"
                                        required />
                                </div>

                                <div>
                                    <label
                                        class="block text-xs font-medium tracking-wide text-zinc-300 mb-1">Content</label>
                                    <textarea id="content"
                                        class="w-full rounded-lg border border-zinc-600 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40"
                                        rows="3" required></textarea>
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center justify-between gap-3 pt-1">
                                <div class="flex items-center gap-2 text-xs text-zinc-400">
                                    <span class="h-1.5 w-1.5 rounded-full bg-indigo-400"></span>
                                    Changes are persisted to your account
                                </div>
                                <button type="submit"
                                    class="inline-flex items-center justify-center rounded-lg bg-indigo-500 px-4 py-2 text-xs font-medium text-white shadow-sm transition hover:bg-indigo-400 cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                                    Add Note
                                </button>
                            </div>
                        </form>

                        <!-- search  -->
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex-1">
                                <input id="search" type="text" placeholder="Search notes by title or content..."
                                    class="w-full rounded-lg border border-zinc-700/70 bg-zinc-950/30 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                            </div>
                            <span class="hidden text-xs text-zinc-400 md:inline">Real-time filtering</span>
                        </div>
                        <div id="notes-empty"
                            class="hidden rounded-2xl border border-dashed border-zinc-800/80 bg-zinc-950/30 p-6 text-center text-sm text-zinc-400">
                            <div class="text-zinc-200 font-medium">No notes yet</div>
                            <div class="mt-1 text-xs text-zinc-400">Add your first note above, or clear the search
                                filter.</div>
                        </div>
                        <ul id="notes-list" class="mt-2 space-y-3 max-h-[420px] overflow-y-auto pr-1"></ul>

                        <!-- undo delete banner -->
                        <div id="undo-delete-banner"
                            class="hidden mt-3 flex items-center justify-between rounded-xl border border-amber-500/40 bg-amber-500/10 px-3 py-2 text-[11px] text-amber-100">
                            <span>Note deleted.</span>
                            <button id="undo-delete-button"
                                class="rounded-lg border border-amber-400/80 bg-amber-500/90 px-3 py-1 text-[11px] font-medium text-amber-950 hover:bg-amber-400 cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500/40">
                                Undo
                            </button>
                        </div>

                        <!-- delete button -->
                        <button id="delete-account"
                            class="mt-6 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 cursor-pointer text-xs font-medium focus:outline-none focus:ring-2 focus:ring-red-500/40">
                            Delete Account
                        </button>

                        <!-- change password button -->

                        <button id="change-password-toggle"
                            class="mt-2 ml-2 bg-amber-500 text-white px-4 py-2 hover:bg-amber-600 rounded cursor-pointer text-xs font-medium focus:outline-none focus:ring-2 focus:ring-amber-500/40">
                            Change Password
                        </button>

                        <div id="change-password-form" class="mt-4 hidden">
                            <div class="space-y-3 rounded-2xl border border-zinc-800/80 bg-zinc-950/40 p-4 shadow-sm">
                                <div>
                                    <label class="block text-xs font-medium tracking-wide text-zinc-300 mb-1">
                                        Current Password
                                    </label>
                                    <input id="current-password" type="password"
                                        class="w-full rounded-lg border border-zinc-600 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                                </div>
                                <div>
                                    <label class="block text-xs font-medium tracking-wide text-zinc-300 mb-1">
                                        New Password
                                    </label>
                                    <input id="new-password" type="password"
                                        class="w-full rounded-lg border border-zinc-600 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                                </div>
                                <div>
                                    <label class="block text-xs font-medium tracking-wide text-zinc-300 mb-1">
                                        Retype New Password
                                    </label>
                                    <input id="confirm-new-password" type="password"
                                        class="w-full rounded-lg border border-zinc-600 bg-zinc-900/60 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/40" />
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button id="cancel-change-password"
                                        class="px-3 py-2 rounded-lg border border-zinc-700/80 bg-zinc-950/30 text-xs text-zinc-200 hover:border-zinc-600 hover:bg-zinc-900/50 cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500/40">
                                        Cancel
                                    </button>
                                    <button id="submit-change-password"
                                        class="bg-amber-500 text-white px-4 py-2 rounded-lg text-xs font-medium hover:bg-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-500/40 cursor-pointer">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>

                    </section>

                </div>
            </main>

            <footer
                class="border-t border-zinc-800/70 px-6 py-3 flex flex-wrap items-center justify-between gap-2 text-[11px] text-zinc-400">
                <span>FastAPI · SQLModel · JWT Auth</span>
                <span>Client-only UI · No external JS frameworks</span>
            </footer>
        </div>
    </div>

    <script>
        let accessToken = null;
        let currentUsername = null;

        function setAuthMessage(text, kind = "info") {
            const el = document.getElementById("auth-message");
            if (!el) return;
            el.textContent = text || "";

            el.className = "min-h-4 text-xs";
            if (!text) {
                el.classList.add("text-zinc-300");
                return;
            }

            if (kind === "success") {
                el.classList.add("text-emerald-300");
            } else if (kind === "error") {
                el.classList.add("text-rose-300");
            } else if (kind === "warning") {
                el.classList.add("text-amber-300");
            } else {
                el.classList.add("text-zinc-300");
            }
        }

        function clearAuthInputs() {
            const userInput = document.getElementById("auth-username");
            const passInput = document.getElementById("auth-password");
            if (userInput) userInput.value = "";
            if (passInput) passInput.value = "";
        }

        function getAuthHeaders(extraHeaders = {}) {
            const headers = { ...extraHeaders };
            if (accessToken) {
                headers["Authorization"] = `Bearer ${accessToken}`;
            }
            return headers;
        }

        function setAuthState(token, username) {
            accessToken = token;
            currentUsername = username;

            if (token && username) {
                localStorage.setItem("access_token", token);
                localStorage.setItem("username", username);
            } else {
                localStorage.removeItem("access_token");
                localStorage.removeItem("username");
            }

            updateUIForAuth();
        }

        function updateUIForAuth() {
            const appSection = document.getElementById("app-section");
            const authStatus = document.getElementById("auth-status");
            const logoutBtn = document.getElementById("btn-logout");
            const authFields = document.getElementById("auth-fields");
            const authButtons = document.getElementById("auth-buttons");
            const emailVerification = document.getElementById("email-verification");

            if (accessToken && currentUsername) {
                appSection.classList.remove("hidden");
                authStatus.textContent = `Logged in as ${currentUsername}`;
                logoutBtn.classList.remove("hidden");
                setAuthMessage("");
                if (authFields) authFields.classList.add("hidden");
                if (authButtons) authButtons.classList.add("hidden");
                if (emailVerification) emailVerification.classList.remove("hidden");
            } else {
                appSection.classList.add("hidden");
                authStatus.textContent = "Not logged in";
                logoutBtn.classList.add("hidden");
                if (authFields) authFields.classList.remove("hidden");
                if (authButtons) authButtons.classList.remove("hidden");
                 if (emailVerification) emailVerification.classList.add("hidden");
            }
        }

        function handleAuthError(response) {
            if (response.status === 401 || response.status === 403) {
                setAuthState(null, null);
                setAuthMessage("Session expired or unauthorized. Please log in again.", "warning");
                return true;
            }
            return false;
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function checkPasswordStrength(password, username) {
            if (password.length < 12) {
                return "Password must be at least 12 characters long.";
            }
            if (!/[a-z]/.test(password)) {
                return "Password must include a lowercase letter.";
            }
            if (!/[A-Z]/.test(password)) {
                return "Password must include an uppercase letter.";
            }
            if (!/[0-9]/.test(password)) {
                return "Password must include a number.";
            }
            if (!/[!@#$%^&*()\-\_=+\[\]{};:,<.>\/?\\|`~]/.test(password)) {
                return "Password must include a special character.";
            }

            const uname = (username || "").toLowerCase();
            const localPart = uname.includes("@") ? uname.split("@")[0] : uname;
            const lowerPw = password.toLowerCase();

            if (uname && lowerPw.includes(uname)) {
                return "Password must not contain your email.";
            }
            if (localPart && lowerPw.includes(localPart)) {
                return "Password must not contain your name/username.";
            }

            const commonWords = ["password", "qwerty", "letmein", "123456", "123456789", "admin"];
            if (commonWords.some((w) => lowerPw.includes(w))) {
                return "Password is too common.";
            }

            return ""; // OK
        }


        async function loadUserProfile() {
            const section = document.getElementById("email-verification");
            const statusEl = document.getElementById("email-verification-status");
            const codeInput = document.getElementById("email-verification-code");
            const sendBtn = document.getElementById("btn-send-verification");
            const verifyBtn = document.getElementById("btn-verify-email");
            const controls = document.getElementById("email-verification-controls");

            if (!section || !statusEl || !accessToken) return;

            const response = await fetch("http://127.0.0.1:8000/users/me", {
                headers: getAuthHeaders(),
            });

            if (!response.ok) {
                if (handleAuthError(response)) return;
                return;
            }

            const user = await response.json();
            const verified = !!user.is_verified;

            if (verified) {
                statusEl.textContent = "Email verified.";
                statusEl.className = "text-[11px] text-emerald-300";
                if (controls) controls.classList.add("hidden");
                if (codeInput) {
                    codeInput.disabled = true;
                    codeInput.value = "";
                }
                if (sendBtn) sendBtn.disabled = true;
                if (verifyBtn) verifyBtn.disabled = true;
            } else {
                statusEl.textContent = "Email not verified. Request a code and check your inbox.";
                statusEl.className = "text-[11px] text-amber-300";
                if (controls) controls.classList.remove("hidden");
                if (codeInput) {
                    codeInput.disabled = false;
                    codeInput.value = "";
                }
                if (sendBtn) sendBtn.disabled = false;
                if (verifyBtn) verifyBtn.disabled = false;
            }
        }



        async function loadNotes(search = '') {
            let url = "http://127.0.0.1:8000/notes";
            if (search && search.trim() !== '') {
                const params = new URLSearchParams({ search });
                url += `?${params.toString()}`;
            }
            const response = await fetch(url, {
                headers: getAuthHeaders(),
            });

            if (!response.ok) {
                if (handleAuthError(response)) return;
                alert("Failed to load notes");
                return;
            }
            const notes = await response.json();

            const list = document.getElementById("notes-list");
            const emptyState = document.getElementById("notes-empty");
            list.innerHTML = '';

            if (!notes || notes.length === 0) {
                if (emptyState) emptyState.classList.remove("hidden");
                return;
            } else {
                if (emptyState) emptyState.classList.add("hidden");
            }

            const undoBanner = document.getElementById("undo-delete-banner");

            notes.forEach((note) => {
                const li = document.createElement("li");
                li.className = "group rounded-2xl border border-zinc-800/80 bg-zinc-950/30 p-4 shadow-sm transition hover:border-indigo-500/50 hover:bg-zinc-950/45 cursor-pointer";
                li.innerHTML = `
                <div class="flex justify-between items-start gap-4">
                    <div class="min-w-0">
                        <h2 class="text-sm font-semibold mb-1 text-zinc-50 truncate">${note.title}</h2>
                        <p class="text-sm text-zinc-200 whitespace-pre-line">${note.content}</p>
                        </div>
                        <div class="space-x-2 shrink-0">
                            <button
                            class="text-xs font-medium text-indigo-300 hover:text-indigo-200 cursor-pointer"
                            data-edit-id="${note.id}"
                            >
                            Edit
                            </button>
                            <button
                            class="text-xs font-medium text-rose-300 hover:text-rose-200 cursor-pointer"
                            data-id="${note.id}"
                            >
                            Delete
                            </button>
                            </div>
                            </div>
                            `;
                list.appendChild(li);
            });

            document.querySelectorAll('button[data-id]').forEach((button) => {
                button.addEventListener('click', async () => {
                    const id = button.getAttribute('data-id');
                    const response = await fetch(`http://127.0.0.1:8000/notes/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders(),
                    });
                    if (!response.ok) {
                        if (handleAuthError(response)) return;
                        alert("Failed to delete note");
                        return;
                    }
                    if (undoBanner) undoBanner.classList.remove("hidden");
                    loadNotes();
                });
            });

            // edit handlers
            document.querySelectorAll('button[data-edit-id]').forEach((button) => {
                button.addEventListener('click', async () => {
                    const id = button.getAttribute('data-edit-id');

                    const currentTitle = prompt('New title (leave blank to keep):');
                    const currentContent = prompt('New content (leave blank to keep):');

                    const body = {};
                    if (currentTitle !== null && currentTitle !== '') {
                        body.title = currentTitle;
                    }
                    if (currentContent !== null && currentContent !== '') {
                        body.content = currentContent;
                    }

                    if (Object.keys(body).length === 0) {
                        return; // nothing to update
                    }

                    const response = await fetch(`http://127.0.0.1:8000/notes/${id}`, {
                        method: 'PUT',
                        headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
                        body: JSON.stringify(body),
                    });

                    if (!response.ok) {
                        if (handleAuthError(response)) return;
                        alert("Failed to update note");
                        return;
                    }

                    loadNotes();
                });
            });
        }

        document.getElementById("note-form").addEventListener("submit", async (event) => {
            event.preventDefault();

            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;

            const response = await fetch("http://127.0.0.1:8000/notes", {
                method: "POST",
                headers: getAuthHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ title, content }),
            });

            if (!response.ok) {
                if (handleAuthError(response)) return;
                alert("Failed to create note");
                return;
            }

            document.getElementById("title").value = "";
            document.getElementById("content").value = "";

            loadNotes();
        })

        // search handler
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.addEventListener('input', (event) => {
                const value = event.target.value;
                loadNotes(value);
            });
        }

        async function loginWithCredentials(username, password, source = "login") {
            setAuthMessage("");

            if (!username || !password) {
                setAuthMessage("Username and password are required.", "error");
                return false;
            }

            const body = new URLSearchParams();
            body.append("username", username);
            body.append("password", password);

            const response = await fetch("http://127.0.0.1:8000/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body,
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                setAuthMessage(data.detail || (source === "register" ? "Auto-login after registration failed" : "Login failed"), "error");
                return false;
            }

            const data = await response.json();
            if (data && data.access_token) {
                setAuthState(data.access_token, username);
                clearAuthInputs();
                setAuthMessage(source === "register" ? "Registered and logged in successfully." : "Logged in successfully.", "success");
                loadUserProfile();
                loadNotes();
                return true;
            } else {
                setAuthMessage("Invalid token response from server.", "error");
                return false;
            }
        }

        // Auth handlers
        document.getElementById("btn-register").addEventListener("click", async () => {
            const username = document.getElementById("auth-username").value.trim();
            const password = document.getElementById("auth-password").value.trim();
            setAuthMessage("");

            if (!username || !password) {
                setAuthMessage("Email and password are required.", "error");
                return;
            }

            if(!isValidEmail(username)){
                setAuthMessage("Please enter a valid email address.", "error");
                return;
            }

            const pwIssue = checkPasswordStrength(password, username);
            if (pwIssue) {
                setAuthMessage(pwIssue, "error");
                return;
            }

            const response = await fetch("http://127.0.0.1:8000/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password }),
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                setAuthMessage(data.detail || "Registration failed", "error");
                return;
            }

            // After successful registration, automatically log in and hide inputs
            await loginWithCredentials(username, password, "register");
        });

        document.getElementById("btn-login").addEventListener("click", async () => {
            const username = document.getElementById("auth-username").value.trim();
            const password = document.getElementById("auth-password").value.trim();
            await loginWithCredentials(username, password, "login");
        });

        document.getElementById("btn-logout").addEventListener("click", () => {
            setAuthState(null, null);
            clearAuthInputs();
            const list = document.getElementById("notes-list");
            if (list) list.innerHTML = "";
            const emptyState = document.getElementById("notes-empty");
            if (emptyState) emptyState.classList.add("hidden");
        });

        // Undo delete handler
        (function setupUndoDelete() {
            const undoBanner = document.getElementById("undo-delete-banner");
            const undoButton = document.getElementById("undo-delete-button");
            if (!undoBanner || !undoButton) return;

            undoButton.addEventListener("click", async (e) => {
                e.preventDefault();

                const response = await fetch("http://127.0.0.1:8000/notes/undo-delete", {
                    method: "POST",
                    headers: getAuthHeaders(),
                });

                if (!response.ok) {
                    if (handleAuthError(response)) return;
                    const data = await response.json().catch(() => ({}));
                    alert("Failed to undo delete: " + (data.detail || "Unknown error"));
                    return;
                }

                undoBanner.classList.add("hidden");
                loadNotes();
            });
        })();

        // Restore auth state from localStorage on load
        (function initAuth() {
            const storedToken = localStorage.getItem("access_token");
            const storedUser = localStorage.getItem("username");
            if (storedToken && storedUser) {
                accessToken = storedToken;
                currentUsername = storedUser;
            }
            updateUIForAuth();
            if (accessToken) {
                loadUserProfile();
                loadNotes();
            }
        })();

        // Email verification handlers
        (function setupEmailVerification() {
            const sendBtn = document.getElementById("btn-send-verification");
            const verifyBtn = document.getElementById("btn-verify-email");

            if (sendBtn) {
                sendBtn.addEventListener("click", async (e) => {
                    e.preventDefault();

                    const response = await fetch("http://127.0.0.1:8000/users/me/send-verification-code", {
                        method: "POST",
                        headers: getAuthHeaders(),
                    });

                    if (!response.ok) {
                        if (handleAuthError(response)) return;
                        const data = await response.json().catch(() => ({}));
                        setAuthMessage(data.detail || "Failed to send verification code.", "error");
                        return;
                    }

                    setAuthMessage("Verification code sent to your email.", "success");
                });
            }

            if (verifyBtn) {
                verifyBtn.addEventListener("click", async (e) => {
                    e.preventDefault();

                    const codeInput = document.getElementById("email-verification-code");
                    const code = codeInput ? codeInput.value.trim() : "";

                    if (!code) {
                        setAuthMessage("Please enter the verification code.", "error");
                        return;
                    }

                    const response = await fetch("http://127.0.0.1:8000/users/me/verify-email", {
                        method: "POST",
                        headers: getAuthHeaders({ "Content-Type": "application/json" }),
                        body: JSON.stringify({ code }),
                    });

                    if (!response.ok) {
                        if (handleAuthError(response)) return;
                        const data = await response.json().catch(() => ({}));
                        setAuthMessage(data.detail || "Failed to verify email.", "error");
                        return;
                    }

                    setAuthMessage("Email verified successfully.", "success");
                    if (codeInput) codeInput.value = "";
                    loadUserProfile();
                });
            }
        })();

        // delete account handler
        const deleteAccountButton = document.getElementById("delete-account");

        if (deleteAccountButton) {
            deleteAccountButton.addEventListener("click", async () => {
                const confirmed = window.confirm(
                    "Are you sure you want to delete your account? This will delete all your notes."
                );
                if (!confirmed) return;


                const token = localStorage.getItem("access_token");
                if (!token) {
                    alert("You are not logged in (no token found).");
                    return;
                }

                const response = await fetch("http://127.0.0.1:8000/users/me", {
                    method: "DELETE",
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                });

                if (response.ok) {
                    // clear auth and go back to main page

                    localStorage.removeItem("access_token");
                    window.location.href = "/";  // this hits your root route -> index.html
                } else {
                    const data = await response.json().catch(() => ({}));
                    alert("Failed to delete account: " + (data.detail || "Unknown error"));
                }
            });
        }

        // change password handler

        const changePasswordToggle = document.getElementById("change-password-toggle");
        const changePasswordForm = document.getElementById("change-password-form");
        const cancelChangePassword = document.getElementById("cancel-change-password");
        const submitChangePassword = document.getElementById("submit-change-password");

        if (changePasswordToggle && changePasswordForm) {
            changePasswordToggle.addEventListener("click", () => {
                changePasswordForm.classList.remove("hidden");
            });
        }

        if (cancelChangePassword && changePasswordForm) {
            cancelChangePassword.addEventListener("click", (e) => {
                e.preventDefault();
                changePasswordForm.classList.add("hidden");
                document.getElementById("current-password").value = "";
                document.getElementById("new-password").value = "";
            });
        }

        if (submitChangePassword) {
            submitChangePassword.addEventListener("click", async (e) => {
                e.preventDefault();

                const currentPassword = document.getElementById("current-password").value;
                const newPassword = document.getElementById("new-password").value;
                const confirmPassword = document.getElementById("confirm-new-password").value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert("Please fill all fields.");
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert("New password and confirmation do not match.");
                    return;
                }

                const token = localStorage.getItem("access_token");
                if (!token) {
                    alert("You are not logged in (no token found).");
                    return;
                }

                const response = await fetch("http://127.0.0.1:8000/users/me/change-password", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                    }),
                });

                if (response.ok) {
                    alert("Password updated successfully. Please log in again.");
                    localStorage.removeItem("access_token");
                    window.location.href = "/";
                } else {
                    const data = await response.json().catch(() => ({}));
                    alert("Failed to change password: " + (data.detail || "Unknown error"));
                }
            });
        }

    </script>
</body>

</html>